<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sliding Puzzle ‚Äî Dynamic</title>
  <style>
    :root { --size: 320px; --gap: 8px; }
    * { box-sizing: border-box; font-family: Inter, system-ui, sans-serif; }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      /* Background s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS khi chuy·ªÉn sang ch·∫ø ƒë·ªô ·∫£nh */
      background: url('https://i.pinimg.com/1200x/5a/f8/42/5af8422bec9048a0eeef3fcc6015813f.jpg') no-repeat center/cover;
      color: #e6eef8;
      transition: background-image 0.5s ease;
    }
    .wrap {
      width: clamp(300px,42vw,520px);
      padding: 20px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    }
    h1 { margin: 0 0 12px; font-size: 20px; text-align: center; }
    .controls { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      justify-content: center; 
      margin-bottom: 12px; 
    }
    button, select {
      background: #0ea5a9;
      border: 0;
      padding: 8px 12px;
      border-radius: 8px;
      color: #042024;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button.secondary, .secondary {
      background: transparent;
      color: #9fc7c6;
      border: 1px solid rgba(159,199,198,0.3);
    }
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: #0ea5a9 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23042024" d="M7 10l5 5 5-5z"/></svg>') no-repeat right 8px center;
        padding-right: 30px;
    }
    .meta { display: flex; gap: 12px; justify-content: center; margin-bottom: 12px; font-size: 14px; color: #9fb7bd; }
    .board {
      --n: 4; /* S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS */
      display: grid;
      grid-template-columns: repeat(var(--n), 1fr);
      gap: 8px;
      width: 100%;
      max-width: var(--size);
      height: var(--size);
      margin: 0 auto;
      background: rgba(255,255,255,0.05);
      padding: 8px;
      border-radius: 10px;
    }
    .tile {
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1/1;
      border-radius: 8px;
      background: linear-gradient(180deg,#660033,#660000); /* M·∫∑c ƒë·ªãnh cho ch·∫ø ƒë·ªô s·ªë */
      color: #012;
      font-size: clamp(18px,3.6vw,26px);
      font-weight: 700;
      user-select: none;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(2,6,23,0.5);
      transition: transform .12s ease;
      /* C√°c thu·ªôc t√≠nh cho ch·∫ø ƒë·ªô ·∫£nh */
      background-size: 400% 400%; /* S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS */
      background-image: none; /* S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS */
    }
    .tile.image-mode {
        background: none;
        color: transparent;
        border: none;
        box-shadow: 0 2px 8px rgba(2,6,23,0.5);
    }
    .tile.empty { background: transparent; box-shadow: none; cursor: default; }
    .hint { font-size: 12px; color: #9fb7bd; text-align: center; margin-top: 10px; }
    .footer { margin-top: 14px; text-align: center; color: #0d3432; font-size: 15px; }
    
    /* CSS cho Modal Chi·∫øn th·∫Øng */
    #winModal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
        background: #042024;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        max-width: 90%;
        color: #e6eef8;
    }
    .modal-content h2 { 
        color: #0ea5a9; 
        margin-top: 0; 
        font-size: 28px; 
    }

    @media (max-width: 420px) { :root { --size: 280px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sliding Puzzle</h1>

    <div class="controls">
      <select id="sizeSelect">
        <option value="3">3x3</option>
        <option value="4" selected>4x4</option>
        <option value="5">5x5</option>
      </select>
      
      <button id="newBtn">New Game</button>
      <button id="shuffleBtn" class="secondary">Shuffle</button>
      <button id="solveBtn" class="secondary">Solve (demo)</button>
      
      <label for="imageUpload" class="secondary" style="padding: 8px 12px; border-radius: 8px; cursor: pointer;">T·∫£i ·∫¢nh L√™n</label>
      <input type="file" id="imageUpload" accept="image/*" style="display: none;">
      <button id="toggleModeBtn" class="secondary">Ch·∫ø ƒë·ªô ·∫¢nh</button>
    </div>

    <div class="meta">
      <div>Moves: <span id="moves">0</span></div>
      <div>Time: <span id="timer">00:00</span></div>
    </div>

    <div class="board" id="board" aria-label="Sliding puzzle board"></div>
    <div class="hint">Nh·∫•p √¥ c·∫°nh √¥ tr·ªëng ƒë·ªÉ di chuy·ªÉn. D√πng ph√≠m m≈©i t√™n c≈©ng ƒë∆∞·ª£c.</div>
    <div class="footer">Starter code ‚Äî ƒë√£ n√¢ng c·∫•p t√≠nh nƒÉng.</div>
  </div>

  <div id="winModal">
    <div class="modal-content">
      <h2>üéâ CH√öC M·ª™NG CHI·∫æN TH·∫ÆNG! üéâ</h2>
      <p id="winMessage" style="font-size: 18px; margin-bottom: 20px;"></p>
      <button id="closeModalBtn">Ch∆°i V√°n M·ªõi</button>
    </div>
  </div>

 <script>
    // Khai b√°o l·∫°i N ƒë·ªÉ s·ª≠ d·ª•ng gi√° tr·ªã t·ª´ Select
    let N = 4; 
    const boardEl = document.getElementById('board');
    const movesEl = document.getElementById('moves');
    const timerEl = document.getElementById('timer');
    const newBtn = document.getElementById('newBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const solveBtn = document.getElementById('solveBtn');
    // C√°c ph·∫ßn t·ª≠ m·ªõi
    const sizeSelect = document.getElementById('sizeSelect');
    const imageUpload = document.getElementById('imageUpload');
    const toggleModeBtn = document.getElementById('toggleModeBtn');
    const winModal = document.getElementById('winModal');
    const winMessage = document.getElementById('winMessage');
    const closeModalBtn = document.getElementById('closeModalBtn');

    let tiles = [];
    let moves = 0;
    let seconds = 0;
    let timerId = null;
    let isImageMode = false;
    // S·ª≠ d·ª•ng URL ·∫£nh n·ªÅn m·∫∑c ƒë·ªãnh t·ª´ CSS ƒë·ªÉ tr√°nh l·ªói
    let defaultImage = "url('https://i.pinimg.com/1200x/81/59/e0/8159e00bf1b72ec93bce8e002d9edc72.jpg')";
    let currentImage = defaultImage;

    function init() {
      // Thi·∫øt l·∫≠p N ban ƒë·∫ßu
      N = parseInt(sizeSelect.value); 
      updateBoardStyle();
      newGame();
      attachEvents();
    }
    
    function updateBoardStyle() {
        boardEl.style.setProperty('--n', N);
    }

    function newGame() {
      tiles = Array.from({ length: N * N }, (_, i) => i);
      shuffle(N * N * 20); // X√°o tr·ªôn nhi·ªÅu h∆°n ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ng·∫´u nhi√™n
      moves = 0;
      seconds = 0;
      updateStats();
      stopTimer();
      render();
    }
    
    // H√†m n√†y c·∫ßn ƒë∆∞·ª£c ch·ªânh s·ª≠a ƒë·ªÉ tr√°nh t·∫°o ra tr·∫°ng th√°i kh√¥ng gi·∫£i ƒë∆∞·ª£c (d√†nh cho n√¢ng cao)
    function shuffle(times = 200) {
      const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
      for (let i = 0; i < times; i++) {
        const emptyIndex = tiles.indexOf(0);
        const {x: ex, y: ey} = idxToXY(emptyIndex);
        const candidates = [];
        dirs.forEach(d => {
          const nx = ex + d[0], ny = ey + d[1];
          if (nx >= 0 && nx < N && ny >= 0 && ny < N)
            candidates.push(xyToIdx(nx, ny));
        });
        const pick = candidates[Math.floor(Math.random() * candidates.length)];
        swap(emptyIndex, pick);
      }
      moves = 0;
      seconds = 0;
      updateStats();
      stopTimer();
      render();
    }

    function render() {
      boardEl.innerHTML = '';
      
      tiles.forEach((val, idx) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.style.transition = 'transform .12s ease'; // ƒê·∫£m b·∫£o hi·ªáu ·ª©ng tr∆∞·ª£t

        if (val === 0) {
          tile.classList.add('empty');
          tile.textContent = '';
        } else {
          // T√≠nh to√°n v·ªã tr√≠ ban ƒë·∫ßu c·ªßa √¥ (0-indexed)
          const solvedIdx = val - 1; 
          const {x: originalX, y: originalY} = idxToXY(solvedIdx);

          if (isImageMode) {
              // Ch·∫ø ƒë·ªô ·∫¢nh
              tile.style.backgroundImage = currentImage;
              tile.style.backgroundSize = `${N * 100}% ${N * 100}%`;
              
              // V·ªã tr√≠ background (√¢m) ƒë·ªÉ c·∫Øt ƒë√∫ng ph·∫ßn ·∫£nh, di chuy·ªÉn theo 100% c·ªßa tile
              const posX = -(originalX * 100); 
              const posY = -(originalY * 100);
              tile.style.backgroundPosition = `${posX}% ${posY}%`;
              
              tile.classList.add('image-mode');
              tile.textContent = '';
          } else {
              // Ch·∫ø ƒë·ªô S·ªë
              tile.textContent = val;
              tile.style.backgroundImage = 'none';
              tile.classList.remove('image-mode');
          }
        }
        
        tile.dataset.idx = idx;
        tile.addEventListener('click', () => onTileClick(idx));
        boardEl.appendChild(tile);
      });
    }

    function idxToXY(i) { return { x: i % N, y: Math.floor(i / N) }; }
    function xyToIdx(x, y) { return y * N + x; }

    function canMove(tileIdx) {
      const emptyIdx = tiles.indexOf(0);
      const a = idxToXY(tileIdx), b = idxToXY(emptyIdx);
      const dist = Math.abs(a.x - b.x) + Math.abs(a.y - b.y);
      return dist === 1;
    }

    function swap(i, j) { [tiles[i], tiles[j]] = [tiles[j], tiles[i]]; }

    function onTileClick(idx) {
      if (tiles[idx] === 0) return;
      if (canMove(idx)) {
        const emptyIdx = tiles.indexOf(0);
        swap(idx, emptyIdx);
        moves++;
        if (moves === 1) startTimer();
        updateStats();
        render();
        if (checkWin()) onWin();
      }
    }

    function updateStats() {
      movesEl.textContent = moves;
      timerEl.textContent = formatTime(seconds);
    }

    function formatTime(s) {
      const mm = String(Math.floor(s / 60)).padStart(2, '0');
      const ss = String(s % 60).padStart(2, '0');
      return `${mm}:${ss}`;
    }

    function startTimer() {
      if (timerId) return;
      timerId = setInterval(() => {
        seconds++;
        updateStats();
      }, 1000);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function checkWin() {
      for (let i = 0; i < tiles.length - 1; i++) {
        if (tiles[i] !== i + 1) return false;
      }
      return tiles[tiles.length - 1] === 0;
    }

    // M√†n h√¨nh Chi·∫øn th·∫Øng (Modal)
    function onWin() {
      stopTimer();
      // Hi·ªÉn th·ªã modal thay v√¨ alert
      winMessage.innerHTML = `B·∫°n ƒë√£ ho√†n th√†nh c√¢u ƒë·ªë **${N}x${N}** trong **${moves} n∆∞·ªõc ƒëi** v·ªõi th·ªùi gian **${formatTime(seconds)}**.`;
      winModal.style.display = 'flex';
    }
    
    // X·ª≠ l√Ω s·ª± ki·ªán b√†n ph√≠m cho di chuy·ªÉn
    function handleKeyDown(e) {
        const empty = tiles.indexOf(0);
        const {x, y} = idxToXY(empty);
        let target = null;
        if (e.key === 'ArrowUp') target = xyToIdx(x, y + 1);
        if (e.key === 'ArrowDown') target = xyToIdx(x, y - 1);
        if (e.key === 'ArrowLeft') target = xyToIdx(x + 1, y);
        if (e.key === 'ArrowRight') target = xyToIdx(x - 1, y);
        
        if (target !== null && target >= 0 && target < N * N) {
          // Ki·ªÉm tra xem n∆∞·ªõc ƒëi c√≥ h·ª£p l·ªá kh√¥ng (c√≥ √¥ n√†o ƒë·ªÉ tr√°o ƒë·ªïi kh√¥ng)
          if (Math.abs(idxToXY(target).x - x) + Math.abs(idxToXY(target).y - y) === 1) {
            swap(empty, target);
            moves++;
            if (moves === 1) startTimer();
            render();
            updateStats();
            if (checkWin()) onWin();
          }
        }
    }

    function attachEvents() {
      newBtn.addEventListener('click', () => newGame());
      shuffleBtn.addEventListener('click', () => shuffle(N * N * 20)); // X√°o tr·ªôn theo k√≠ch th∆∞·ªõc N
      solveBtn.addEventListener('click', demoSolve);
      
      // X·ª≠ l√Ω Thay ƒë·ªïi K√≠ch th∆∞·ªõc B√†n c·ªù
      sizeSelect.addEventListener('change', () => {
        N = parseInt(sizeSelect.value);
        updateBoardStyle();
        isImageMode = false; // Reset mode khi ƒë·ªïi size
        toggleModeBtn.textContent = 'Ch·∫ø ƒë·ªô ·∫¢nh';
        newGame();
      });

      // X·ª≠ l√Ω Modal
      closeModalBtn.addEventListener('click', () => {
        winModal.style.display = 'none';
        newGame();
      });

      // X·ª≠ l√Ω Ch·∫ø ƒë·ªô ·∫¢nh
      toggleModeBtn.addEventListener('click', () => {
        isImageMode = !isImageMode;
        toggleModeBtn.textContent = isImageMode ? 'Ch·∫ø ƒë·ªô S·ªë' : 'Ch·∫ø ƒë·ªô ·∫¢nh';
        render(); // Render l·∫°i b√†n c·ªù ngay l·∫≠p t·ª©c
      });

      imageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            currentImage = `url('${URL.createObjectURL(file)}')`;
            // L·ªói ƒë√£ ƒë∆∞·ª£c s·ª≠a: Lo·∫°i b·ªè d√≤ng document.body.style.backgroundImage = 'none'; 
            // Gi·ªØ nguy√™n background m·∫∑c ƒë·ªãnh c·ªßa body.
            isImageMode = true;
            toggleModeBtn.textContent = 'Ch·∫ø ƒë·ªô S·ªë';
            newGame(); // B·∫Øt ƒë·∫ßu v√°n m·ªõi v·ªõi ·∫£nh m·ªõi
        }
      });

      window.addEventListener('keydown', handleKeyDown);
    }

    function demoSolve() {
      if (confirm('Demo: ƒê·∫∑t l·∫°i v·ªÅ tr·∫°ng th√°i ho√†n th√†nh?')) {
        tiles = Array.from({ length: N * N }, (_, i) => i);
        render();
        moves = 0;
        seconds = 0;
        updateStats();
        stopTimer();
      }
    }

    init();
  </script>
</body>
</html>